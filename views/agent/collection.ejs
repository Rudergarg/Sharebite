<main class="bg-light min-vh-100 p-3">
  <%- include('../partials/agentSidebar') %>

  <div id="main-wrapper" class="container py-4">

    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between bg-white shadow-sm p-3 rounded mb-4">
      <div class="d-flex align-items-center">
        <span class="me-3" id="sidebar-toggler-btn">
          <i class="fas fa-bars fs-5"></i>
        </span>
        <h4 class="m-0 text-primary fw-bold">Collection Details</h4>
      </div>
    </div>

    <!-- Main Card -->
    <div class="card shadow border-0 p-4 animate__animated animate__fadeIn">

      <!-- Donor & Food Info -->
      <div class="row mb-3">

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Donor Name</span>
          <div class="fs-6 fw-bold">
            <%= collection.donor.firstName + " " + collection.donor.lastName %>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Food Type</span>
          <div class="fs-6 fw-bold"><%= collection.foodType %></div>
        </div>

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Quantity</span>
          <div class="fs-6 fw-bold"><%= collection.quantity %></div>
        </div>

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Time of Cooking</span>
          <div class="fs-6 fw-bold">
            <%= collection.cookingTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) %>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Address to Collect</span>
          <div class="fs-6 fw-bold"><%= collection.address %></div>
        </div>

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Phone</span>
          <div class="fs-6 fw-bold"><%= collection.phone %></div>
        </div>

        <div class="col-md-6 mb-3">
          <span class="text-muted small fw-semibold">Status</span>
          <div class="mt-1">
            <span class="badge px-3 py-2 
              <% if(collection.status === 'assigned'){ %> bg-warning text-dark 
              <% } else if(collection.status === 'collected'){ %> bg-success 
              <% } else { %> bg-secondary <% } %>">
              <%= collection.status %>
            </span>
          </div>
        </div>

      </div>

      <!-- Admin Message -->
      <% if(collection.status == "assigned" && collection.adminToAgentMsg != "") { %>
      <div class="mb-4 p-3 bg-white border shadow-sm rounded position-relative" style="border-left: 5px solid #0d6efd;">
        <span class="fw-semibold text-primary"><i class="fas fa-envelope me-2"></i>Message from Admin:</span>
        <div class="mt-2 text-secondary"><%= collection.adminToAgentMsg %></div>
      </div>
      <% } %>

      <!-- Collection Time -->
      <% if(collection.status == "collected") { %>
      <div class="mb-4">
        <span class="text-muted small fw-semibold">Collection Time</span>
        <div class="fs-6 fw-bold">
          <%= collection.collectionTime.toLocaleString("en-IN", { dateStyle: "medium", timeStyle: "short"}) %>
        </div>
      </div>
      <% } %>

      <!-- Freshness Check Button -->
      <div class="mt-4 text-center">
        <button class="btn btn-primary btn-lg px-4 shadow-sm" onclick="checkFreshness()">
          <i class="fas fa-check-circle me-2"></i> Check Freshness
        </button>
      </div>

      <!-- Freshness Result -->
      <div id="freshness-result"
           class="mt-4 p-4 rounded shadow-sm text-center animate__animated animate__fadeIn"
           style="display:none; background:#f8f9fa;">
        <h5 class="fw-bold mb-2 text-primary">Freshness Result</h5>
        <p id="result-text" class="fs-5">Checking...</p>
      </div>

    </div>
  </div>
</main>

<!-- Animations CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<script>
const ESP32_API_URL = "http://10.136.181.140/read";

async function checkFreshness() {
    const resultBlock = document.getElementById("freshness-result");
    const resultText = document.getElementById("result-text");

    resultBlock.style.display = "block";
    resultText.innerHTML = "Checking...";

    try {
        const res = await fetch(ESP32_API_URL);
        const data = await res.json();

        let message = "";
        let colorClass = "";

        if (data.status === "fresh") {
            message = "Food is Fresh ✔";
            colorClass = "text-success";
            resultBlock.style.background = "#d4edda";
        } 
        else if (data.status === "spoiled") {
            message = "Food Spoiled ⚠️";
            colorClass = "text-danger";
            resultBlock.style.background = "#f8d7da";
        } 
        else {
            message = "Unknown Status";
            colorClass = "text-warning";
            resultBlock.style.background = "#fff3cd";
        }

        resultText.innerHTML = `
            <span class="${colorClass} fw-bold">${message}</span><br>
            <span class="text-muted">Gas Level:</span> ${data.gas}
        `;

    } catch (e) {
        console.error(e);
        resultText.innerHTML = `<span class="text-danger fw-bold">Error: ESP32 Not Connected</span>`;
        resultBlock.style.background = "#f8d7da";
    }
}
</script>
